<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Adminbereich</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { margin-top: 20px; }
        .warning-box {
            background-color: #ffe5e5;
            border: 2px solid #ff5c5c;
            color: #a40000;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .warning-icon { font-size: 22px; }
        table { border-collapse: collapse; }
        th, td { border: 1px solid #555; padding: 6px 10px; }
        button { margin: 6px 0; padding: 6px 10px; }
    </style>

    <script>
        async function clockUser(userId) {
            const resBox = document.getElementById("response");
            resBox.innerText = "Wird gesendet...";
            try {
                const response = await fetch("/api/clock", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                resBox.innerText = data.message || "Keine Antwort.";
                setTimeout(() => window.location.reload(), 2000);
            } catch {
                resBox.innerText = "Fehler beim Senden.";
            }
        }
    </script>
</head>
<body>
    <h1>Administratorbereich – Willkommen, {{ name }}</h1>

    <p>
        <a href="/logout">Logout</a> |
        <a href="/admin/fix_errors">Fehlerzeiten korrigieren</a>
    </p>

    <button onclick="clockUser('{{ admin_id }}')">An- / Abmelden</button>
    <pre id="response"></pre>

    {% if has_pending_corrections %}
        <div class="warning-box">
            <span class="warning-icon">⚠️</span>
            <span>Neue automatisch gesetzte Buchungen erkannt!<br>
            Bitte „Fehlerzeiten korrigieren“ öffnen.</span>
        </div>
    {% endif %}

    <hr>

    <h2>Benutzerverwaltung</h2>
    <table>
        <tr><th>User-ID</th><th>Name</th><th>Rolle</th><th>Aktionen</th></tr>
        {% for uid, user in users.items() %}
            <tr>
                <td>{{ uid }}</td>
                <td><a href="/admin/user/{{ uid }}">{{ user.first_name }} {{ user.last_name }}</a></td>
                <td>{{ user.role }}</td>
                <td><a href="/admin/edit_user/{{ uid }}">Bearbeiten</a></td>
            </tr>
        {% endfor %}
    </table>

    <h3>Neuen Benutzer anlegen</h3>
    <form method="POST" action="/admin/add_user">
        <input name="first_name" placeholder="Vorname" required>
        <input name="last_name" placeholder="Nachname" required>
        <input name="nfc_code" placeholder="NFC-Code">
        <input name="password" placeholder="Passwort" required>
        <select name="role">
            <option value="user">Mitarbeiter</option>
            <option value="admin">Administrator</option>
        </select>
        <button type="submit">Anlegen</button>
    </form>

    <hr>
    <h2>Monatsreport ({{ report.year }}-{{ '%02d' % report.month }})</h2>
    <table>
        <tr><th>User-ID</th><th>Name</th><th>Gesamtstunden</th></tr>
        {% for uid, data in report.users.items() %}
            <tr>
                <td>{{ uid }}</td>
                <td>{{ data.name }}</td>
                <td>{{ data.total_hm }}</td>
            </tr>
        {% endfor %}
    </table>
</body>
</html>
